name: Daily Newsletter Digest

on:
  schedule:
    - cron: '0 8 * * 1-5'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        default: 'false'
        type: boolean
      output_html:
        description: 'Save HTML as artifact'
        required: false
        default: 'true'
        type: boolean
      brief_mode:
        description: 'Brief generation mode'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - anthropic
          - copilot

permissions:
  discussions: write
  contents: write
  issues: write
  models: read

jobs:
  build-newsletter:
    name: Build & Publish Newsletter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download newsletter PHAR
        run: |
          gh release download --repo ${{ github.repository }} --pattern 'newsletter.phar' --dir ./bin || {
            echo "::error::No PHAR release found. Please create a release first (tag v*)."
            exit 1
          }
          chmod +x ./bin/newsletter.phar
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install GitHub Models extension
        if: inputs.brief_mode == 'copilot'
        run: gh extension install github/gh-models
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Ensure config exists
        run: |
          if [ ! -f config/newsletter.yaml ]; then
            cp config/newsletter.yaml.dist config/newsletter.yaml
          fi

      - name: Build newsletter
        id: build
        run: |
          DRY_RUN_FLAG=""
          OUTPUT_FLAG=""
          BRIEF_FLAGS=""

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          if [[ "${{ inputs.output_html }}" == "true" ]] || [[ "${{ inputs.dry_run }}" == "true" ]]; then
            OUTPUT_FLAG="--output=newsletter-output.html"
          fi

          BRIEF_MODE="${{ inputs.brief_mode }}"
          if [[ "${BRIEF_MODE}" == "anthropic" ]] && [[ -n "${ANTHROPIC_API_KEY}" ]]; then
            BRIEF_FLAGS="--anthropic-api-key=${ANTHROPIC_API_KEY}"
          elif [[ "${BRIEF_MODE}" == "copilot" ]]; then
            BRIEF_FLAGS="--copilot"
          fi

          php ./bin/newsletter.phar newsletter:build \
            --config=config/newsletter.yaml \
            --templates=templates \
            --repository=${{ github.repository }} \
            --discussion-category=General \
            --archive-dir=newsletters \
            ${BRIEF_FLAGS} \
            ${DRY_RUN_FLAG} \
            ${OUTPUT_FLAG} \
            -v
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}

      - name: Commit newsletter archive
        if: success() && inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add newsletters/
          git diff --cached --quiet || git commit -m "ðŸ“° Archive newsletter $(date +%Y-%m-%d)"
          git push

      - name: Upload HTML artifact
        if: always() && (inputs.output_html == 'true' || inputs.dry_run == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-${{ github.run_id }}
          path: newsletter-output.html
          retention-days: 30
          if-no-files-found: ignore
